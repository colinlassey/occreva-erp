generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum WorkspaceRole {
  ADMIN
  FINANCE
  PM
  TEAM_MEMBER
  CLIENT
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
}

enum DeliverableStatus {
  DRAFT
  IN_REVIEW
  APPROVED
}

enum InvoiceStatus {
  DRAFT
  APPROVED
  SENT
  PAID
  VOID
}

enum CommunicationType {
  NOTE
  EMAIL
  PORTAL_MESSAGE
}

enum InvoiceLineType {
  TIME
  FIXED_FEE
  EXPENSE
}

model Workspace {
  id         String   @id @default(cuid())
  name       String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  created_by String
  updated_by String
  deleted_at DateTime?

  users                UserWorkspace[]
  clients              ClientAccount[]
  projects             Project[]
  tasks                Task[]
  deliverables         Deliverable[]
  time_entries         TimeEntry[]
  invoices             Invoice[]
  payments             Payment[]
  communication_events CommunicationEvent[]
  file_assets          FileAsset[]
  automation_rules     AutomationRule[]
  audit_logs           AuditLog[]

  @@index([deleted_at])
}

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  name       String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  created_by String
  updated_by String
  deleted_at DateTime?

  workspaces    UserWorkspace[]
  project_roles ProjectMember[]
  time_entries  TimeEntry[]

  @@index([deleted_at])
}

model UserWorkspace {
  id           String        @id @default(cuid())
  workspace_id String
  user_id      String
  role         WorkspaceRole
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt
  created_by   String
  updated_by   String
  deleted_at   DateTime?

  workspace Workspace @relation(fields: [workspace_id], references: [id])
  user      User      @relation(fields: [user_id], references: [id])

  @@unique([workspace_id, user_id])
  @@index([workspace_id, role])
}

model ClientAccount {
  id          String   @id @default(cuid())
  workspace_id String
  name        String
  status      String
  owner_id    String?
  tags        String[]
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  created_by  String
  updated_by  String
  deleted_at  DateTime?

  workspace            Workspace             @relation(fields: [workspace_id], references: [id])
  contacts             Contact[]
  projects             Project[]
  invoices             Invoice[]
  communication_events CommunicationEvent[]

  @@index([workspace_id, status])
  @@index([workspace_id, name])
}

model Contact {
  id                String   @id @default(cuid())
  workspace_id      String
  client_account_id String
  name              String
  email             String
  phone             String?
  title             String?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  created_by        String
  updated_by        String
  deleted_at        DateTime?

  workspace      Workspace     @relation(fields: [workspace_id], references: [id])
  client_account ClientAccount @relation(fields: [client_account_id], references: [id])

  @@index([workspace_id, email])
  @@index([client_account_id])
}

model Project {
  id                String        @id @default(cuid())
  workspace_id      String
  client_account_id String
  name              String
  status            ProjectStatus @default(DRAFT)
  budget_type       String
  starts_at         DateTime?
  ends_at           DateTime?
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt
  created_by        String
  updated_by        String
  deleted_at        DateTime?

  workspace      Workspace      @relation(fields: [workspace_id], references: [id])
  client_account ClientAccount  @relation(fields: [client_account_id], references: [id])
  members        ProjectMember[]
  tasks          Task[]
  deliverables   Deliverable[]
  time_entries   TimeEntry[]

  @@index([workspace_id, status])
  @@index([client_account_id])
}

model ProjectMember {
  id           String   @id @default(cuid())
  workspace_id String
  project_id   String
  user_id      String
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  created_by   String
  updated_by   String
  deleted_at   DateTime?

  workspace Workspace @relation(fields: [workspace_id], references: [id])
  project   Project   @relation(fields: [project_id], references: [id])
  user      User      @relation(fields: [user_id], references: [id])

  @@unique([project_id, user_id])
  @@index([workspace_id, user_id])
}

model Task {
  id             String     @id @default(cuid())
  workspace_id   String
  project_id     String
  deliverable_id String?
  title          String
  description    String?
  status         TaskStatus @default(TODO)
  due_date       DateTime?
  priority       Int        @default(2)
  assignee_id    String?
  created_at     DateTime   @default(now())
  updated_at     DateTime   @updatedAt
  created_by     String
  updated_by     String
  deleted_at     DateTime?

  workspace   Workspace    @relation(fields: [workspace_id], references: [id])
  project     Project      @relation(fields: [project_id], references: [id])
  deliverable Deliverable? @relation(fields: [deliverable_id], references: [id])

  @@index([workspace_id, status])
  @@index([project_id, due_date])
}

model Deliverable {
  id                  String            @id @default(cuid())
  workspace_id        String
  project_id          String
  title               String
  acceptance_criteria String?
  status              DeliverableStatus @default(DRAFT)
  version_link        String?
  created_at          DateTime          @default(now())
  updated_at          DateTime          @updatedAt
  created_by          String
  updated_by          String
  deleted_at          DateTime?

  workspace    Workspace  @relation(fields: [workspace_id], references: [id])
  project      Project    @relation(fields: [project_id], references: [id])
  tasks        Task[]
  time_entries TimeEntry[]

  @@index([workspace_id, status])
  @@index([project_id])
}

model TimeEntry {
  id             String   @id @default(cuid())
  workspace_id   String
  user_id        String
  project_id     String
  task_id        String?
  deliverable_id String?
  invoice_id     String?
  entry_date     DateTime
  duration_mins  Int
  notes          String?
  billable       Boolean  @default(true)
  approved       Boolean  @default(false)
  locked         Boolean  @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  created_by     String
  updated_by     String
  deleted_at     DateTime?

  workspace   Workspace    @relation(fields: [workspace_id], references: [id])
  user        User         @relation(fields: [user_id], references: [id])
  project     Project      @relation(fields: [project_id], references: [id])
  task        Task?        @relation(fields: [task_id], references: [id])
  deliverable Deliverable? @relation(fields: [deliverable_id], references: [id])
  invoice     Invoice?     @relation(fields: [invoice_id], references: [id])

  @@index([workspace_id, entry_date])
  @@index([project_id, approved])
  @@index([invoice_id])
}

model Invoice {
  id                String        @id @default(cuid())
  workspace_id      String
  client_account_id String
  invoice_number    String
  status            InvoiceStatus @default(DRAFT)
  issued_at         DateTime?
  due_date          DateTime
  subtotal_cents    Int
  tax_cents         Int           @default(0)
  discount_cents    Int           @default(0)
  total_cents       Int
  currency          String        @default("USD")
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt
  created_by        String
  updated_by        String
  deleted_at        DateTime?

  workspace      Workspace         @relation(fields: [workspace_id], references: [id])
  client_account ClientAccount     @relation(fields: [client_account_id], references: [id])
  line_items     InvoiceLineItem[]
  time_entries   TimeEntry[]
  payments       Payment[]

  @@unique([workspace_id, invoice_number])
  @@index([workspace_id, status])
  @@index([due_date])
}

model InvoiceLineItem {
  id             String          @id @default(cuid())
  workspace_id   String
  invoice_id     String
  time_entry_id  String?
  line_type      InvoiceLineType
  description    String
  quantity       Decimal         @db.Decimal(10, 2)
  unit_price     Decimal         @db.Decimal(10, 2)
  total_price    Decimal         @db.Decimal(10, 2)
  created_at     DateTime        @default(now())
  updated_at     DateTime        @updatedAt
  created_by     String
  updated_by     String
  deleted_at     DateTime?

  workspace  Workspace @relation(fields: [workspace_id], references: [id])
  invoice    Invoice   @relation(fields: [invoice_id], references: [id])

  @@index([workspace_id, invoice_id])
}

model Payment {
  id                   String   @id @default(cuid())
  workspace_id         String
  invoice_id           String
  amount_cents         Int
  paid_at              DateTime
  reference_note       String?
  provider_reference   String?
  reconciliation_state String?
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt
  created_by           String
  updated_by           String
  deleted_at           DateTime?

  workspace Workspace @relation(fields: [workspace_id], references: [id])
  invoice   Invoice   @relation(fields: [invoice_id], references: [id])

  @@index([workspace_id, paid_at])
  @@index([invoice_id])
}

model CommunicationEvent {
  id                String            @id @default(cuid())
  workspace_id      String
  client_account_id String
  project_id        String?
  type              CommunicationType
  body              String
  client_visible    Boolean           @default(false)
  occurred_at       DateTime          @default(now())
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt
  created_by        String
  updated_by        String
  deleted_at        DateTime?

  workspace      Workspace     @relation(fields: [workspace_id], references: [id])
  client_account ClientAccount @relation(fields: [client_account_id], references: [id])

  @@index([workspace_id, occurred_at])
  @@index([client_account_id])
}

model FileAsset {
  id           String   @id @default(cuid())
  workspace_id String
  name         String
  storage_key  String
  mime_type    String
  external_url String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  created_by   String
  updated_by   String
  deleted_at   DateTime?

  workspace Workspace @relation(fields: [workspace_id], references: [id])

  @@index([workspace_id])
}

model AutomationRule {
  id              String   @id @default(cuid())
  workspace_id    String
  name            String
  trigger_type    String
  conditions_json Json
  actions_json    Json
  is_active       Boolean  @default(true)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  created_by      String
  updated_by      String
  deleted_at      DateTime?

  workspace Workspace @relation(fields: [workspace_id], references: [id])

  @@index([workspace_id, is_active])
}

model AuditLog {
  id             String   @id @default(cuid())
  workspace_id   String
  actor_user_id  String
  entity_type    String
  entity_id      String
  action         String
  previous_state Json?
  next_state     Json?
  metadata       Json?
  created_at     DateTime @default(now())

  workspace Workspace @relation(fields: [workspace_id], references: [id])

  @@index([workspace_id, entity_type, entity_id])
  @@index([created_at])
}
